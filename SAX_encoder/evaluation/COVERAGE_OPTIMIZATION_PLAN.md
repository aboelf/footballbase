# SAX编码覆盖率提升方案

## 当前问题诊断

### 覆盖率计算错误

当前脚本计算覆盖率的方式：
```python
coverage = covered_matches / len(matches)
```

但实际上，**大部分比赛都有SAX编码，只是它们不属于"高纯模式"**。真正的覆盖率应该统计：
1. **所有被SAX编码覆盖的比赛**（无论纯度如何）
2. **使用软匹配/相似模式**（汉明距离<2的模式视为同类）
3. **分层分类**（先用粗粒度分类，再细分）

---

## 覆盖率提升策略

### 策略1: 正确的覆盖率定义

**真实覆盖率 = 能被SAX编码分类的比赛数 / 总比赛数**

当前仅14.5%是因为只统计了"高纯模式"，但实际上：
- 所有比赛都可以被SAX编码
- 问题不是"能否编码"，而是"编码后结果是否可靠"

**建议改为**：
- **覆盖率**: 所有有SAX编码的比赛比例（应该接近100%）
- **高置信度覆盖率**: 高纯模式覆盖的比赛比例（当前14.5%）
- **可用覆盖率**: 纯度>60%或样本数>20的模式覆盖的比赛比例

---

### 策略2: 降低模式空间

当前 `individual (4×3)` 产生 12字符的编码：
- 主胜(4) + 平局(4) + 客胜(4) = 12字符
- 模式空间: 3^12 = 531,441 种

**优化方案**:

| 方案 | 编码长度 | 模式空间 | 优点 | 缺点 |
|------|---------|---------|------|------|
| 当前(4×3 individual) | 12 | 531,441 | 信息完整 | 过于分散 |
| **推荐: 3×3 individual** | 9 | 19,683 | **集中度提高27倍** | 信息略少 |
| 2×3 individual | 6 | 729 | 非常集中 | 信息损失大 |
| interleaved (4×3) | 4 | 81 | 最集中 | 信息混合 |

**推荐**: 使用 `word_size=3, alphabet_size=3` 的 individual 编码

---

### 策略3: 软匹配/相似模式聚类

**问题**: 严格字符串匹配过于严格，`abc` 和 `abd` 被视为完全不同的模式

**解决方案**: 汉明距离匹配
```python
def find_similar_patterns(target_pattern, pattern_library, max_distance=1):
    """找到与目标模式相似的所有模式"""
    similar = []
    for pattern in pattern_library:
        distance = sum(1 for a, b in zip(target_pattern, pattern) if a != b)
        if distance <= max_distance:
            similar.append(pattern)
    return similar
```

**效果**: 
- `abc` 和 `abd` (距离=1) 视为同类
- 覆盖率可提升 3-5倍
- 需要权衡：纯度会略微下降

---

### 策略4: 分层分类策略

**第一层**: 粗粒度分类（区分主胜/平局/客胜大方向）
- 使用 `interleaved (4×3)` 
- 模式: 4字符，81种可能

**第二层**: 细粒度分类（在大方向内细分）
- 对纯度<70%的模式，使用 `individual (3×3)` 再细分
- 或引入其他特征（球队排名、赔率绝对值等）

**效果**: 
- 第一层覆盖 100% 比赛
- 第二层对 40-50% 比赛给出高置信度预测

---

### 策略5: 多庄家融合（最有效）

**当前单庄家覆盖率**: 14.5%
**双庄家融合覆盖率**: 14.4%（任一庄家覆盖）

**但**: 两庄家都覆盖时，预测一致性 91.57%

**优化方案**:
1. 分别建立两个庄家的模式库
2. 新比赛编码后，查询两个庄家的模式库
3. **融合策略**:
   - 两庄家都高纯且一致 → 高置信度预测
   - 只有一个高纯 → 中置信度预测
   - 都不高纯 → 低置信度（不预测）

**预期效果**:
- 高置信度覆盖率: ~10%
- 中置信度覆盖率: ~25%
- 总可用覆盖率: ~35%（接近40%目标）

---

### 策略6: 动态阈值

**问题**: 固定70%阈值过于严格

**解决方案**: 根据模式样本数动态调整阈值
```python
def dynamic_threshold(sample_count):
    """
    样本越多，允许阈值越低
    样本越少，要求阈值越高
    """
    if sample_count >= 50:
        return 0.60  # 大样本，60%纯度即可
    elif sample_count >= 20:
        return 0.65
    elif sample_count >= 10:
        return 0.70
    else:
        return 0.75  # 小样本，要求更高纯度
```

---

## 推荐实施方案

### 方案A: 快速见效（1天内）

1. **降低编码长度**: individual 4×3 → 3×3
2. **降低纯度阈值**: 70% → 65%
3. **降低最小样本**: 10 → 5

**预期效果**:
- 覆盖率: 14.5% → 25-30%
- 平均纯度: 75% → 70-72%

### 方案B: 中等投入（1周内）

1. 实施**软匹配**（汉明距离≤1）
2. 实施**动态阈值**
3. 增加**多庄家融合**

**预期效果**:
- 覆盖率: 14.5% → 35-40%
- 高置信度预测准确率: 75%+

### 方案C: 长期优化（1月内）

1. **分层分类**: 粗分+细分
2. **引入更多特征**: 球队排名、历史交锋
3. **机器学习**: 用SAX编码作为特征训练分类器

**预期效果**:
- 覆盖率: >50%
- 预测准确率: 70%+

---

## 立即执行的优化代码

```python
# 优化后的评估参数
OPTIMAL_CONFIG = {
    'strategy': 'individual',
    'word_size': 3,          # 从4降到3
    'alphabet_size': 3,
    'min_samples': 5,        # 从10降到5
    'purity_threshold': 0.65, # 从0.70降到0.65
    'top_n': 50,             # 从20增加到50
    'use_soft_match': True,  # 启用软匹配
    'hamming_distance': 1
}

# 预期覆盖率: 25-30%
# 预期平均纯度: 70-72%
```

---

## 验证方法

运行优化后的评估：

```bash
cd SAX_encoder

# 测试优化参数
python evaluation/test_optimized_params.py \
  --data "1.generateOddsDetail/SAX encoder/bookmaker_details/bet_365_details.json" \
  --word-size 3 \
  --alphabet-size 3 \
  --min-samples 5 \
  --purity-threshold 0.65
```

---

## 结论

覆盖率提升的关键：

1. **降低粒度**: 4×3 → 3×3 (集中度提高27倍)
2. **放宽阈值**: 70% → 65% (纳入更多模式)
3. **软匹配**: 汉明距离≤1的模式视为同类
4. **多庄家**: 融合Bet365+Easybets数据
5. **分层分类**: 先粗分再细分

**推荐立即执行方案A**，预期覆盖率从14.5%提升到25-30%，同时保持70%+的平均纯度。
